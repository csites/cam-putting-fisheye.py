The fisheye_lens correction consists of several utilities to assist in camera setup and allignment, camera calibration and calibration testing.   If you have ever used Allexx's original cam_putting.py you will see that it assumes a nearly perfect overhead camera view.  This implies your putting line is straight and the ball motion does not bow left or right.  With a fisheye camera, the bowing from lens distortions, typically is more pronounced at the edges.  The steps needed to get the cam putting working well are 1) align the camera, 2) print out a chessboard.  3) Move a chessboard into the camera field of view and take several samples of the chessboard image.  4) run the camera calibration to create destortion arrays, 5) verify the destortion in real time, 6) test in with the real cam-putting.py and verify by feel of the putt.   

The first step in you need to do is allign you putting line with the vertical center.  So if your webcam is 640w x 480h you would want to allign your putting line to exactly 240h.  If done so accurately, you can use your fisheye camera without calibration mostly.  The ball speed can be affected if your perfectly inline and that's about it.  The program for allignment is called Simple_cam_allign.py.  It ask for the camera number (0-3), and then displays the camera configuration, the live camera video with some allignment marks to define the putt line, outer edges of the frame.  You can flip the image back and forth with the 'f' key.  This is to help you adjust the camera in an intuitive way.  'q' quits.  It helps to have an alignment stick in the camera view so you can see your putt line.  If you have a Simulator screen aligned to the projector center, when putting in using cam-putting.py, the flag on the greens should be exactly center.  I put a piece of white tape at the bottom center of the screen as my putting target.  

Once you have your camera aligned and fixed in place; you will need to calibrate for the for the fisheye lens distortion.   This is done with the program 'Snapshots2.py' We need to have checkerboard pattern printed out (or use a foldup chessboard).  Run he Snapshots2.py program, give it the camera number (0-4) and the number of snapshots you want to make.  Place the chessboard in the view of the cam, and let the program take a snapshot. It will display the snapshot, you then have 5 seconds to move the chessboard to a new location, and repeat. If you can try to get an a few images with the chessboard close to the screen, and moved back.  All the images will be stored in 'fisheye/Calibrations/ subdir.  You can create your own chessboard pattern created at this site (if you have a printer of course).  https://markhedleyjones.com/projects/calibration-checkerboard-collection and create/download and print a custom chessboard pattern for the typepaper your using; default is A4, Custom Standard Letter is 215mm x 279mm. 30mm squares works OK. 

Note: if your using an IR camera with fisheye, the paper can appear too bright close up. If that is the case you may need to turn off you IR lighting, and use a standard camera mode. 

Once your satisfied with your calibration images, it's time to run the calibration and compute the Lens distortion values (K, D, and scaled_K). You run this with 'calibration_fisheye2.py'.  this will read in all of the images in the fisheye/Calibrations/ subdir, and throw out any images it can't use. It uses all of the good chessboards images to create you K and D and scaled_K arrays used to de-distort the image.  The K, D, and scaled_K are written into the config.ini in top directory (where the cam_putting.py is located.  Check and visually inspect the new undistorted image for any bowing of lines.  If there are some, it will likly be do the collection of calibration images.   Depending on amount of correction, you will be presented an de-distorted image corrected for the fisheye len distorions. However, you will notice some bowing of the outside edges. That is normal. 

You can test the K-D lens de-distortion functions using a real camera view.  After your calibation and the config.ini has the K-D-scaled_K arrays, you can see what the correction would looklike on your cam using the utility 'Undistored_simple_cam.py'  

Once calibrated, the cam-putting-fisheye.py will now correct the ball speed and HLA values that are distored in a fisheye lens.  If the the cam-putting-fisheye.py has K is not defined, it will not be used and the program will at like Alexx's orginal.  If K is defined, it reads that the arrays from the calibration step and applies that to remap the image (X, Y) points into the undistorted (X, Y) points.

The next step in the processes is a correction for perspect mapping.  Optional as well.  If your camera is not looking directly down on the floor, say its mounted next to your putting mat, and looking down at an angle, it will create a perspective distorion. This can affect the Horizontal Launch Angle (HLA) by a couple of degrees.  If we correct for this, after fixing the fisheye, we should be able to flattenthe image.  All the measurements should be corrected for once the perspective is corrected for.

What this will allow you to do is if you have a very large sim screen and you are projecting the game from ceiling to floor, is an immersive putting simulation. So you putting is towards the center of the screen.  So from you putting circle, you should be able to align you shot to the point on the screen you putting towards.  So you can align your putts without the need to place the game's allignment post.  Just aim and shoot like it's the real thing.  How cool is that?


